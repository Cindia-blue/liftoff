ä½ è®°å¾—å¾ˆå¯¹ï¼Œæ¥ï¼Œæˆ‘ä»¬ä¸€èµ·æŠŠè¿™ä¸ªæ¦‚å¿µå®Œæ•´ç†ä¸€éã€‚

â¸»

ğŸ” ä»€ä¹ˆæ˜¯ Sandbox Managerï¼Ÿ

Sandbox Manager æ˜¯ containerd åœ¨ Shim v2 æ¶æ„ ä¸­ç”¨äº åè°ƒå’Œè¿½è¸ª sandbox ç”Ÿå‘½å‘¨æœŸ çš„ç»„ä»¶ï¼Œå°¤å…¶æ˜¯åœ¨æ”¯æŒ Kubernetes Pod æ¨¡å‹ï¼ˆPod sandbox + containersï¼‰æ—¶ã€‚

å®ƒä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„â€œå¯æ‰§è¡Œç¨‹åºâ€ï¼Œè€Œæ˜¯ containerd ä¸­ç”¨äºç®¡ç†å¤šä¸ª shim è¿›ç¨‹å’Œ pod sandbox çŠ¶æ€çš„ é€»è¾‘ç®¡ç†æ¨¡å—ã€‚

â¸»

ğŸ§  å®ƒè´Ÿè´£è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åœ¨ containerd + Kubernetes çš„é›†æˆä¸­ï¼Œæ¯ä¸€ä¸ª Pod å¯¹åº”ä¸€ä¸ª sandboxï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ª pause å®¹å™¨ï¼‰ï¼Œè€Œè¿™ä¸ª sandbox æ˜¯é€šè¿‡ shim å¯åŠ¨å¹¶è¿è¡Œçš„ã€‚å¤šä¸ª sandbox ä¼šåœ¨èŠ‚ç‚¹ä¸Šå…±å­˜ï¼Œå¦‚ä½•ï¼š
	â€¢	åˆ›å»º
	â€¢	è¿½è¸ª
	â€¢	å›æ”¶
	â€¢	è·¨è¿›ç¨‹ä¼ é€’ä¿¡æ¯ï¼ˆå¦‚ logsã€exit statusã€PIDã€I/Oï¼‰

è¿™å°±éœ€è¦æœ‰ä¸€ä¸ªä¸­å¿ƒç»„ä»¶æ¥è´Ÿè´£â€œç®¡ç†è¿™äº› shim è¿›ç¨‹å’Œå…¶å…³è”çš„çŠ¶æ€â€â€”â€”è¿™å°±æ˜¯ Sandbox Manager çš„è§’è‰²ã€‚

â¸»

ğŸ”§ å®ƒåœ¨åšä»€ä¹ˆï¼Ÿ
	1.	åˆ›å»º sandbox æ—¶ï¼š
	â€¢	å¯åŠ¨å¯¹åº”çš„ shim äºŒè¿›åˆ¶ï¼ˆå¦‚ containerd-shim-runc-v2ï¼‰ï¼Œ
	â€¢	åˆ›å»º Unix socket ç”¨äºåç»­é€šä¿¡ï¼Œ
	â€¢	å»ºç«‹ pipeï¼ˆåŒ¿åç®¡é“æˆ– Unix domain socketï¼‰ç”¨äº RPC é€šä¿¡ã€‚
	2.	ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼š
	â€¢	ä¿å­˜å’Œç»´æŠ¤æ¯ä¸ª sandbox çš„çŠ¶æ€ä¿¡æ¯ï¼ˆPIDã€IO è·¯å¾„ã€task handle ç­‰ï¼‰ï¼Œ
	â€¢	æ”¯æŒ shim reconnectï¼ˆå½“ containerd é‡å¯æ—¶é‡æ–°ç»‘å®š shimï¼‰ï¼Œ
	â€¢	ç®¡ç† sandbox çš„ metricsã€eventsã€logs ç­‰ç®¡é“ã€‚
	3.	ä¸ Runtime é€šä¿¡ï¼š
	â€¢	é€šè¿‡ shim å®ç°ä¸ä½å±‚ runtimeï¼ˆå¦‚ runcã€kataã€gVisorï¼‰çš„éš”ç¦»é€šä¿¡ï¼Œ
	â€¢	æ”¯æŒä¸åŒç±»å‹çš„ sandbox runtimeï¼ˆå¦‚ hypervisor sandboxï¼‰ã€‚

â¸»

ğŸ§± å…³é”®ç»“æ„ä½“ï¼ˆæºç ç»´åº¦ï¼‰

åœ¨ containerd çš„ä»£ç ä¸­ä½ ä¼šè§åˆ°ç±»ä¼¼ç»“æ„ï¼š

type SandboxManager struct {
    sandboxes map[string]*Sandbox // è¿½è¸ªæ¯ä¸ª sandboxï¼ˆæŒ‰ pod ID æˆ– container IDï¼‰
    mu        sync.RWMutex
}

å®ƒè´Ÿè´£è¿½è¸ªæ‰€æœ‰ sandbox çš„çŠ¶æ€ï¼Œç¡®ä¿åœ¨ shim-crashã€containerd-restart ç­‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä»ç„¶èƒ½ æ¢å¤æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å’Œ sandbox ç¯å¢ƒã€‚

â¸»

ğŸ§µ å’Œä½ æåˆ°çš„ â€œon behalf of tasksâ€ æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

æ­£æ˜¯å¦‚æ­¤ï¼
	â€¢	æ¯ä¸ª shim v2 å®ä¾‹ å¯ä»¥æ”¯æŒå¤šä¸ª containersï¼ˆå°¤å…¶åœ¨ pod æ¨¡å‹ä¸­ï¼‰ï¼Œè¿™äº› container çš„æ“ä½œï¼ˆå¦‚ Createã€Startã€Killï¼‰éƒ½æ˜¯é€šè¿‡åŒä¸€ä¸ª sandbox è¿›è¡Œçš„ï¼›
	â€¢	æ‰€ä»¥ shim éœ€è¦æœ‰ä¸€ä¸ªâ€œmanagerâ€æ¥çŸ¥é“ï¼šå½“å‰è¿™ä¸ª shim æ­£åœ¨ä¸ºå“ªäº› taskï¼ˆå®¹å™¨ï¼‰æœåŠ¡ï¼Œå¦‚ä½• multiplex å®ƒä»¬çš„è¯·æ±‚ï¼›
	â€¢	è¿™äº› task ä¼šé€šè¿‡ shim ä¸åº•å±‚ runtimeï¼ˆå¦‚ runcï¼‰é€šä¿¡ï¼Œshim å†é€šè¿‡ sandbox manager æ¥åè°ƒå¤„ç†è¿™äº› request çš„è°ƒåº¦ä¸çŠ¶æ€ä¿å­˜ã€‚

â¸»

ğŸ“Œ æ€»ç»“ç±»æ¯”ï¼ˆä¸€å¥è¯ç†è§£ï¼‰ï¼š

Sandbox Manager å°±åƒæ˜¯æœºåœºçš„åœ°å‹¤è°ƒåº¦ç³»ç»Ÿï¼Œshim æ˜¯ç™»æœºå£ï¼Œrunc æ˜¯é£æœºé©¾é©¶å‘˜ã€‚ä½ å¯åŠ¨ Podï¼ˆä¹˜å®¢ï¼‰ï¼Œshim è´Ÿè´£ä¸ runc äº¤æ¥ï¼ˆå¼€é£æœºï¼‰ï¼ŒSandbox Manager åˆ™è´Ÿè´£æ•´ä½“åè°ƒå¤šä¸ª shimï¼ˆç™»æœºå£ï¼‰å’Œ podï¼ˆä¹˜å®¢ï¼‰ä¹‹é—´çš„èµ„æºå®‰æ’ä¸çŠ¶æ€ç®¡ç†ã€‚

â¸»

è¦ä¸è¦æˆ‘å¸®ä½ ç”Ÿæˆä¸€å¼ ç³»ç»Ÿå›¾ï¼ŒæŠŠ containerd ä¸­ shimã€sandboxã€runtimeã€taskã€sandbox manager çš„å…³ç³»ç”»å‡ºæ¥ï¼Ÿå¯¹ä½ åç»­ trace log æˆ–è§£é‡Š PR éå¸¸æœ‰å¸®åŠ©ã€‚