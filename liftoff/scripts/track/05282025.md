å¤ªå¥½äº†ï¼Œæˆ‘ä»¬é©¬ä¸Šå¼€å§‹æ„å»ºä½ çš„ ğŸ¯Pinterest å…¥èŒ Narrative æ­¦å™¨åŒ… v1.0ã€‚è¿™å¥—å†…å®¹å°†å¸®åŠ©ä½ ï¼š
	â€¢	ä»ç¬¬ä¸€å¤©èµ·æ¤å…¥ç³»ç»Ÿå½’å±æ„Ÿï¼›
	â€¢	æœ‰æ•ˆåº”å¯¹â€œç»“æ„æƒè¢«å¸æ”¶â€çš„é£é™©ï¼›
	â€¢	æ„å»ºå‡ºä¸€å¥—ä½ ä½œä¸º Cloud Runtime Owner çš„è¯­è¨€æ§åˆ¶æƒï¼›

â¸»

ğŸ§° Narrative æ­¦å™¨åŒ…ï¼ˆå®Œæ•´ç‰ˆï¼‰

â¸»

âœ… Part 1ï¼šå…¥èŒå‰ä¸¤å‘¨è¡¨è¾¾å¥å‹åŒ…ï¼ˆé€‚ç”¨äº 1:1ã€å›¢é˜ŸåŒæ­¥ã€Slackã€tech syncï¼‰

ğŸ™ åœºæ™¯ï¼šä½ åˆæ¬¡ä¸ provisioning peerã€manager æˆ– principal å·¥ç¨‹å¸ˆæ²Ÿé€š

ğŸ”¹ å»ºç«‹å®šä½æ„Ÿ

â€œIâ€™m here not just to debug issues in the runtime, but to help us define what a healthy container execution contract looks like â€” before rollout ever happens.â€

ğŸ”¹ æ¡†å®šåˆä½œæ–¹å¼ï¼ˆé¿å…â€œä½ ä¿®æˆ‘åšâ€çš„ä¸‹ä½ç»“æ„ï¼‰

â€œRather than fix things after rollout, Iâ€™d like to build a traceable readiness path between runtime signals and provisioning standards â€” that way we can catch problems upstream.â€

ğŸ”¹ åœ¨ç¬¬ä¸€æ¬¡æ metric trace æ—¶

â€œOne thing Iâ€™ll be focusing on this month is making our container lifecycle more observable â€” not just for failures, but for what â€˜normalâ€™ should look like.â€

â¸»

âœ… Part 2ï¼šcontainerd trace ownership è¡¨è¾¾æ¨¡æ¿ï¼ˆåœ¨ä»£ç  reviewã€è®¾è®¡è®¨è®ºã€PR è¯´æ˜ä¸­ä½¿ç”¨ï¼‰

åœºæ™¯	è¡¨è¾¾å¥
æå‡ºæ’æ¡© patch æ—¶	â€œThis trace point helps link container startup delay to underlying shim execution latency â€” it gives us a root cause path instead of just symptom collection.â€
æä¾› debug è§£é‡Š	â€œFrom this trace, we can see that task creation bottlenecks are runtime-specific â€” provisioning is seeing the impact, but not the origin.â€
ä¸å›¢é˜Ÿåä½œäº¤æ¥	â€œLetâ€™s define together what startup readiness means in container terms â€” I can own tracing it, and we can build rollout expectations around it.â€


â¸»

âœ… Part 3ï¼šNarrative è¢«å¸æ”¶æ—¶çš„åè½¬è¯æœ¯ï¼ˆé€‚ç”¨äºä¼šè®®ã€æ€»ç»“ã€é‚®ä»¶ï¼‰

ğŸ­ åœºæ™¯å†ç°ï¼š

ä»–å¯¹ä¸Šå±‚æˆ–å›¢é˜Ÿè¯´ï¼šâ€œRuntime å‡ºäº†ç‚¹é—®é¢˜ï¼Œæˆ‘ä»¬ rollout å performance ä¸å¤ªè¡Œï¼Œå¥½åœ¨ debug å·¥ç¨‹å¸ˆæ‰¾åˆ°äº† root causeã€‚â€

â¸»

ğŸŸ¥ é”™è¯¯å›åº”æ–¹å¼ï¼ˆå¤ªæ¿€çƒˆï¼‰ï¼š

â€œæˆ‘ä¸æ˜¯ debug å·¥ç¨‹å¸ˆï¼Œæˆ‘æ˜¯æ¶æ„å¸ˆï¼â€âŒï¼ˆæƒ…ç»ªå¯¹äº†ï¼Œä½† narrative å´©äº†ï¼‰

â¸»

âœ… å»ºè®®å›åº”ï¼ˆä¼˜é›…è€Œç²¾å‡†ï¼‰ï¼š

â€œActually what we identified wasnâ€™t just a one-off bug â€” itâ€™s a recurring pattern when the container runtime isnâ€™t scoped explicitly in the rollout assumptions.
Thatâ€™s why Iâ€™m building trace logic upstream â€” so weâ€™re not fixing surprises later.â€

æˆ–æ›´è½»ä¸€ç‚¹ç‰ˆæœ¬ï¼š

â€œI think of it less as fixing bugs, and more like clarifying where the boundaries of container readiness should live â€” the trace just happens to make it measurable.â€

â¸»

âœ… Part 4ï¼šRuntime Owner çš„ rollout è§„èŒƒå®šä¹‰æ¨¡æ¿ï¼ˆSLA / GC é¢„ç®— / startup latencyï¼‰

ğŸ¯ ä½¿ç”¨æ–¹å¼ï¼šåœ¨è®¾è®¡å®¡æŸ¥ã€tech planningã€æ–‡æ¡£ä¸­è®¾å®šè¾¹ç•Œæ„Ÿã€‚

ğŸ“¦ Startup SLA å®šä¹‰ï¼š

## Container Startup SLA (Initial Baseline)

- startup_duration_p99 < 4s
- shim_launch_time < 2s
- task_create_to_ready < 1s
- startup_trace coverage: 90% containers traced per namespace

ğŸ§¹ GC & Reclaim Budgetï¼š

## GC Budget Assumptions (Overlay snapshot GC)

- snapshot cleanup TTL < 10 min after container exit
- async reclaim should not block next container create
- if reclaim > 2s, emit `gc_degraded` metric

ğŸ” Observability Ownership æ¨¡æ¿ï¼ˆä½ ä¸»å¼ çš„è¾¹ç•Œï¼‰ï¼š

As runtime owner, I define and trace:

- what "healthy container behavior" means;
- how performance signals should propagate to provisioning;
- and when rollout should halt based on runtime anomalies.


â¸»

ğŸ’¡ Bonusï¼šä½ å¯ä»¥æ”¾è¿› Confluence/Wiki çš„æ€»ç»“æè¿°ï¼ˆè®© narrative å¯è§åŒ–ï¼‰

â€œIn Cloud Runtime, we donâ€™t just react to container regressions.
We define container performance expectations, trace them end-to-end, and close the feedback loop from infra to rollout.
Itâ€™s not debug â€” itâ€™s contract enforcement.â€

â¸»

âœ… ä¸‹ä¸€æ­¥å»ºè®®ï¼š

ä½ å¯ä»¥ç°åœ¨å¼€å§‹ï¼š
	1.	æŠŠä»¥ä¸Šè¡¨è¾¾ copy è¿›ä½  Notion / Draft æ–‡æ¡£ä¸­ï¼›
	2.	ç­‰ä½ å¼€å§‹ 1:1 æˆ–åˆå§‹äº¤æ¥ä¼šè®®å‰ï¼ŒæŒ‘é€‰åˆé€‚çš„å¥å‹ç»ƒä¹ æ¼”è®²è¯­æ„Ÿï¼›
	3.	æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ åˆ¶ä½œ æ¯æ¡ containerd ä¸»çº¿ + ownership framing å¥—è¯­ï¼Œæ¯”å¦‚ â€œCreate path å¦‚ä½•è¡¨è¾¾ contract ownershipâ€ã€‚

ä½ æƒ³ä»å“ªæ¡ä¸»çº¿å¼€å§‹æ„ narrative framingï¼Ÿæˆ‘ä»¬å¯ä»¥ç°åœ¨å¼€å§‹ã€‚







åœ¨ Containerd çš„æºç ä¸­ï¼Œå’Œä½ ç›®å‰è®¾æƒ³æœ‰å…³çš„ validation logicã€test infrastructure å’Œå¯é‡ç”¨çš„æ¨¡å— åˆ†å¸ƒä¸»è¦å¦‚ä¸‹ï¼š

â¸»

âœ… ä¸€ã€å¯é‡ç”¨çš„ Validation Logic

1. containerd/pkg/validate/validate.go
	â€¢	åŒ…å«é€šç”¨çš„ Validate æ¥å£å®šä¹‰ï¼Œä¸»è¦ç”¨äºæ’ä»¶æˆ–é…ç½®çš„åˆè§„æ£€æŸ¥ã€‚
	â€¢	æ”¯æŒå¯¹ runtime options, OCI runtime spec, labels, annotations ç­‰å­—æ®µçš„åˆè§„æ€§æ ¡éªŒã€‚

2. containerd/oci/spec_opts.go
	â€¢	å¤šæ•°ç”¨äºç»„è£…æœ€ç»ˆçš„ OCI spec çš„ option å‡½æ•°ï¼Œä¾‹å¦‚ WithMounts, WithDefaultSpec, WithApparmorProfileã€‚
	â€¢	æ¯ä¸ª option éƒ½å¯èƒ½è¿›è¡Œ runtime å‚æ•°åˆæ³•æ€§æ£€æŸ¥ã€‚

3. containerd/oci/validation.go
	â€¢	æ­¤å¤„åŒ…å«ä¸€äº›æ›´åº•å±‚çš„å…³äº spec ç»“æ„ä½“çš„æ ¡éªŒï¼Œå°¤å…¶ç”¨äº runtime compatibility å’Œ spec conformanceã€‚
	â€¢	å¯å•ç‹¬æŠ½å‡ºä¸ºç‹¬ç«‹åº“ä½¿ç”¨ã€‚

4. containerd/pkg/cri/server/container_create.go
	â€¢	generateContainerSpec() å’Œ containerSpecOpts() å‡½æ•°æ˜¯æ„å»ºå®¹å™¨ Spec çš„æ ¸å¿ƒã€‚
	â€¢	åŒ…å«å¯¹æ³¨å…¥å‚æ•°ï¼ˆå¦‚ envã€mountã€resourcesï¼‰çš„å°è£…ä¸åˆæ³•æ€§åˆ¤æ–­ã€‚

â¸»

âœ… äºŒã€å·²æœ‰çš„ Test ç»“æ„ä¸ Mock æµ‹è¯•æ¨¡å—

1. containerd/pkg/cri/server/container_create_test.go
	â€¢	å«æœ‰å¤§é‡é€šè¿‡ mock runtime å®ä¾‹ã€æ„é€  fake container config æ¥æµ‹è¯• container create spec çš„ç”¨ä¾‹ã€‚
	â€¢	å¯ç”¨ä½œè¾¹ç•Œæ¡ä»¶æ¨¡æ‹Ÿçš„åŸºå‡†æµ‹è¯•ã€‚

2. containerd/pkg/testutil/ ç›®å½•
	â€¢	åŒ…å« mock sandbox/container configã€fake OCI specã€å‡ runtime metadata çš„æ„é€ å·¥å…·ã€‚
	â€¢	å¯ä»¥æ–¹ä¾¿åœ°åš mock validator CLI æˆ–æ‰“åŒ…ä¸º sidecar æ ¡éªŒå™¨ã€‚

â¸»

âœ… ä¸‰ã€CLI/Sidecar å¯æ•´åˆçš„æ–¹å¼

ä½ æåˆ°çš„æ–¹å‘ï¼ˆå°† validation tool CLI åŒ–ï¼‰åœ¨ä»¥ä¸‹è·¯å¾„å·²æœ‰æ‰€ä½“ç°ï¼š

1. cmd/ctr/commands/run/run_unix.go
	â€¢	æ”¯æŒé€šè¿‡ CLI åˆ›å»ºå®¹å™¨ï¼Œå¯ä»¥åŠ  hooks æ’å…¥éªŒè¯æµç¨‹ã€‚

2. test/integration/ å’Œ test/container/ è·¯å¾„
	â€¢	å­˜åœ¨ä½¿ç”¨å®Œæ•´ runtimeã€plugin è·¯å¾„çš„ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•ã€‚
	â€¢	ä½ å¯ä»¥åŸºäºè¿™äº›è„šæœ¬æ„å»º Sidecar æˆ– pipeline éªŒè¯å™¨ã€‚

â¸»

âœ… æ¨èä½ å…ˆæ‹†è§£çš„ä¸‰ç»„ä»£ç è·¯å¾„ï¼š

è·¯å¾„	ç”¨é€”	æ˜¯å¦å¯æå–
pkg/validate	é€šç”¨éªŒè¯æ¡†æ¶ï¼ˆå­—æ®µä¸ç»“æ„åˆæ³•æ€§ï¼‰	âœ… å¯æŠ½å‡ºå°è£…
oci/spec_opts.go	OCI è§„èŒƒæ„é€ å’Œå‚æ•°æ³¨å…¥	âœ… å¯é›†æˆæˆ–å¤ç”¨
cri/server/container_create_test.go	æµ‹è¯•å®¹å™¨é…ç½®åˆæ³•æ€§ï¼ˆmock testï¼‰	âœ… å¯ç‹¬ç«‹ç¼–è¯‘ä¸ºæ ¡éªŒå™¨


â¸»

âœ… æ¥ä¸‹æ¥å»ºè®®ä½ åšçš„ï¼š
	1.	å…ˆæå– validate.go + spec_opts.go ä¸­å¯å•å…ƒåŒ–çš„é€»è¾‘ã€‚
	2.	å°† container_create_test.go ä¸­çš„ mock æµ‹è¯•é‡æ„ä¸ºå‘½ä»¤è¡Œå·¥å…·ã€‚
	3.	å°è¯•åœ¨æœ¬åœ°æˆ– Pinterest ç¯å¢ƒæ‰“åŒ…æˆ sidecar å®¹å™¨ï¼Œæ¥å…¥ pipelineã€‚

æˆ‘å¯ä»¥åœ¨ä½ çœ‹å®Œ CNCF çš„åˆ†äº«åå¸®ä½ ç”Ÿæˆè¿™äº›è·¯å¾„çš„ä»£ç å›¾è§£ç»“æ„å›¾ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿä¹Ÿå¯ä»¥ä¸ºä½ æ‰“åŒ…ä¸€ä¸ª minimal validator CLI åŸå‹ã€‚éœ€è¦å—ï¼Ÿ