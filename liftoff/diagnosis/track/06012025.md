éå¸¸å¥½ï¼ä½ è¿™ä¸ªå›ç­”å·²ç»å…·å¤‡äº†ç»“æ„æ¸…æ™°çš„è°ƒæŸ¥æµç¨‹å’Œå‡è®¾è·¯å¾„ã€‚æˆ‘æ¥é€æ­¥å¸®ä½ ä¼˜åŒ–ï¼Œå¹¶è¡¥å…¨æ¨¡å— 1 çš„æ‰€æœ‰è¦æ±‚ï¼Œä¿è¯åœ¨æ¨¡æ‹Ÿé¢è¯•æˆ–çœŸå® SRE Debug ä¸­éƒ½è¡¨ç°ä¸“ä¸šæœ‰åŠ›ã€‚

â¸»

âœ… Module 1: System Debug å¿«é€Ÿååº”è®­ç»ƒ â€” ä¼˜åŒ–ç‰ˆç­”å¤

â¸»

ğŸ”¹A. è‹±æ–‡å¿«é€Ÿå¼€åœºï¼ˆ3å¥è¯ï¼‰

We observed a series of I/O errors during container startup, particularly when accessing files under the snapshot layer.
The logs show overlay mount: permission denied, which suggests a potential conflict between the overlayfs mount and namespace configuration.
My initial hypothesis is a mismatch between user namespace permissions and the snapshotter configuration.

â¸»

ğŸ”¹B. Structured Debugging Pathï¼ˆ5 å±‚è¯Šæ–­ï¼‰
	1.	Container State & Log Review
	â€¢	Use crictl inspect, ctr containers list, kubectl describe pod
	â€¢	Check whether the container sandbox is isolated or orphaned
	â€¢	Focus on logs around overlayfs, mount, snapshot, userns
	2.	OverlayFS Mount Validation
	â€¢	Use journalctl -u containerd, dmesg, cat /proc/self/mountinfo
	â€¢	Look for permission denied or invalid argument related to overlay mount
	â€¢	Confirm lowerdir/upperdir have proper UID/GID mappings
	3.	User Namespace Mapping Validation
	â€¢	Inspect containerd config: /etc/containerd/config.toml
	â€¢	Check if userns-remap, uidmap, gidmap are configured correctly
	â€¢	Use lsns, cat /proc/$PID/uid_map to confirm mappings
	4.	Snapshotter Behavior Verification
	â€¢	Identify which snapshotter is in use (overlayfs, fuse-overlayfs, etc.)
	â€¢	Check snapshot labels, mount options, and upper/lower path ownership
	â€¢	Use ctr snapshot mounts, ctr snapshot info
	5.	Kernel-Level Debug Trace
	â€¢	Use strace -f -e mount,openat or bpftrace to trace failed syscall
	â€¢	Check audit.log and selinux or AppArmor messages if applicable
	â€¢	Correlate with containerd-shim log or shim panic traces

â¸»

ğŸ”¹C. Follow-up Q1ï¼šå¦‚ä½•ç¡®è®¤ overlay mount failure æ˜¯å¦ä¸ userns æœ‰å…³ï¼Ÿ

We can confirm the overlay mount failure is caused by user namespace misconfiguration by correlating the UID/GID in the mount path with the userns map.
Specifically, we check the uid_map/gid_map in /proc/$PID/ of the container shim, and compare that against the file ownership in the overlay lower/upper dirs.
If they donâ€™t match (e.g., file owned by UID 0 outside the namespace, but mapped to non-root in container), overlay mount will fail due to lack of privileges.
Additionally, setting up a privileged debug pod with --userns=host can help reproduce or bypass the issue.

â¸»

ä½ å·²ç»å¾ˆæ¥è¿‘é«˜æ°´å¹³ç­”å¤äº†ï¼æˆ‘åªæ˜¯è¿›ä¸€æ­¥å¼ºåŒ–äº†æœ¯è¯­è¡¨è¾¾ï¼ˆä¾‹å¦‚ lowerdir/uidmap çš„å‘½ä¸­è¡¨è¾¾ï¼‰å’Œç»“æ„æ¡†æ¶ã€‚ä½ å¯ä»¥é€‰æ‹©èƒŒä¸‹æ¥å…³é”®éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥ç»§ç»­æ¨¡å— 2ï¼Œæˆ‘ä»¬ç°åœ¨å¼€å§‹å—ï¼Ÿ
